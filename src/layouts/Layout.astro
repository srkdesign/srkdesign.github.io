---
import i18n from "i18next";
import { SITE_TITLE } from "../consts";

import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header";
import Footer from "../components/Footer";

const { title, description, locale } = Astro.props;
const isBlogPage = Astro.url.pathname.includes("blog");
const postImage = `/images${Astro.url.pathname}hero.png`;
---

<html lang={locale || i18n.language} class="text-base">
  <head>
    <BaseHead
      title={title || SITE_TITLE}
      description={description || i18n.t("site.description")}
      image={isBlogPage && Astro.url.pathname != "/blog/"
        ? postImage
        : `/image.png`}
    />
  </head>
  <body class="text-zinc-50 bg-zinc-950">
    <!-- Loader -->
    <div class="page-loader">
      <div class="loader-content"></div>
    </div>
    <!-- Content -->
    <div id="swup">
      <Header client:only="react" />
      <main class="pt-28">
        <slot />
      </main>
      <Footer client:only="react" />
      <!-- {!isBlogPage ? <DiscussProject client:only="react" /> : ""} -->
    </div>
  </body>
</html>

<script>
  import Swup from "swup";
  import SwupHeadPlugin from "@swup/head-plugin";
  import SwupBodyClassPlugin from "@swup/body-class-plugin";
  import SwupPreloadPlugin from "@swup/preload-plugin";

  const pageLoader = document.querySelector(".page-loader") as HTMLElement;
  const swupContainer: HTMLElement | null = document.querySelector(
    "#swup",
  ) as HTMLElement;

  function showLoader() {
    pageLoader.classList.remove("is-exiting");
    pageLoader.classList.add("is-entering");
  }

  function hideLoader() {
    pageLoader.classList.remove("is-entering");
    pageLoader.classList.add("is-exiting");
  }

  window.addEventListener("load", () => {
    setTimeout(() => {
      hideLoader();
    }, 200);
  });

  const swup = new Swup({
    containers: ["#swup"],
    plugins: [
      new SwupPreloadPlugin({ preloadHoveredLinks: true }),
      new SwupHeadPlugin({ persistTags: true, awaitAssets: true }),
      new SwupBodyClassPlugin(),
    ],
  });

  function waitForImage(img: HTMLImageElement): Promise<void> {
    if (img.complete) return Promise.resolve();
    return new Promise((resolve) => {
      img.onload = () => resolve();
      img.onerror = () => resolve();
      setTimeout(() => resolve(), 3000);
    });
  }

  function waitForVideo(video: HTMLVideoElement): Promise<void> {
    if (video.readyState >= 3) return Promise.resolve();
    return new Promise((resolve) => {
      video.oncanplay = () => resolve();
      video.oncanplaythrough = () => resolve();
      video.onerror = () => resolve();

      if (video.preload === "none") {
        video.preload = "metadata";
        video.load();
      }

      setTimeout(() => resolve(), 3000);
    });
  }

  async function waitForMedia(container: HTMLElement) {
    const images = Array.from(
      container.querySelectorAll("img:not([loading='lazy'])"),
    ).filter((el): el is HTMLImageElement => el instanceof HTMLImageElement);

    const videos = Array.from(container.querySelectorAll("video")).filter(
      (el): el is HTMLVideoElement => el instanceof HTMLVideoElement,
    );

    await Promise.all([
      ...images.map(waitForImage),
      ...videos.map(waitForVideo),
    ]);
  }

  swup.hooks.on("animation:out:start", async () => {
    showLoader();
    if (swupContainer) {
      swupContainer.style.opacity = "0";
      await waitForMedia(swupContainer);
    }
  });

  swup.hooks.on("animation:in:start", async () => {
    if (swupContainer) {
      swupContainer.style.opacity = "1";
      await waitForMedia(swupContainer);
    }

    hideLoader();
  });
</script>
